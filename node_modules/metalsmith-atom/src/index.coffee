Metalsmith = require 'metalsmith'
Timestamp = require 'internet-timestamp'
# FS = require 'fs'
URL = require 'url'
Util = require 'util'

buildAtomFromCollections = (opts, metalsmith, atom) ->
  url = opts.url
  meta = metalsmith.metadata()
  date = meta.date

  buffer = """<?xml version="1.0" encoding="utf-8"?>

  <feed xmlns="http://www.w3.org/2005/Atom">

    <title>#{atom.title}</title>
    <id>#{url}/</id>
    <link href="#{url}/#{atom.atomFile}" rel="self" />
    <updated>#{Timestamp(date)}</updated>
    """

  # console.log "Creating atom from collections #{atom.collections}"
  for targetCollectionName in atom.collections
    targetCollection = meta.collections[targetCollectionName]
    # console.log "Target collection : #{targetCollection}"
    for entry in targetCollection
      entry.author = {} unless entry.author?
      entry.author_name = "Anonymous" unless entry.author_name?
      entry.author_email = "anonymous@example.com" unless entry.author_email?
      entry.date = new Date(0) unless entry.date?

      buffer = buffer + """
      <entry>
          <title>#{entry.title}</title>
          <id>#{generateId(url, entry)}</id>
          <link href="#{url}/#{entry.path}" />
          <updated>#{Timestamp(entry.date)}</updated>
          <author>
            <name>#{entry.author_name}</name>
            <email>#{entry.author_email}</email>
          </author>
          <summary>#{entry.excerpt}</summary>
       </entry>
  """

  buffer = buffer + "</feed>"
  return buffer

generateId = (url, entry) ->
  try
    parsedUrl = URL.parse(url)
    d = entry.date
    dateString = String('00'+d.getDate()).slice(-2)
    monthString = String('00'+d.getMonth()).slice(-2)
    id = "tag:#{parsedUrl.host},#{d.getFullYear()}-#{monthString}-#{dateString}:/#{entry.path}"
  catch error
    console.log "Error generating ID from : #{url} and #{Util.inspect(entry)}"

setup = (opts, collections) ->
  return (files, metalsmith, done) ->
    try
      for key, atom of collections
        buffer = buildAtomFromCollections(opts, metalsmith, atom)
        file =
          contents: buffer
          mode: "0644"
        files[atom.atomFile] = file
    catch error
      console.log "Error building atom file : #{error}"
    done()

module.exports = setup
